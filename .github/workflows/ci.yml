name: CI

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

env:
  CARGO_TERM_COLOR: always

jobs:
  lint:
    name: üîç Lint
    runs-on: ubuntu-latest
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v6

      - name: ü¶Ä Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy

      - name: üì¶ Cache Cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-lint-${{ hashFiles('**/Cargo.lock') }}

      - name: üìé Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  build:
    name: üöß Build (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact-base: scout-linux-x64

          - os: macos-latest
            target: x86_64-apple-darwin
            artifact-base: scout-macos-x64

          - os: macos-latest
            target: aarch64-apple-darwin
            artifact-base: scout-macos-arm64

          - os: windows-latest
            target: x86_64-pc-windows-msvc
            artifact-base: scout-windows-x64

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v6

      - name: ü¶Ä Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: üì¶ Cache Cargo
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-${{ matrix.target }}-cargo-build-${{ hashFiles('**/Cargo.lock') }}

      # --- macOS x64 ONNX Runtime build ---
      - name: üî® Build ONNX Runtime from Source (macOS x64)
        if: matrix.target == 'x86_64-apple-darwin'
        run: |
          git clone --recursive --depth 1 https://github.com/microsoft/onnxruntime.git
          cd onnxruntime
          ./build.sh \
            --config Release \
            --parallel \
            --skip_tests \
            --cmake_extra_defines CMAKE_OSX_ARCHITECTURES=x86_64 \
            --cmake_extra_defines FETCHCONTENT_FULLY_DISCONNECTED=OFF
        shell: bash

      # --- Build Image-Only Variant (Default) ---
      - name: üöß Build Release Binary - Image Only (macOS x64)
        if: matrix.target == 'x86_64-apple-darwin'
        run: cargo build --release --target ${{ matrix.target }}
        env:
          ORT_STRATEGY: system
          ORT_LIB_LOCATION: ${{ github.workspace }}/onnxruntime/build/MacOS/Release
          ORT_USE_STATIC_LIBS: true

      - name: üöß Build Release Binary - Image Only (Other Platforms)
        if: matrix.target != 'x86_64-apple-darwin'
        run: cargo build --release --target ${{ matrix.target }}

      # --- Build Video Variant (With FFmpeg) ---
      - name: üé• Build Release Binary - With Video Support (macOS x64)
        if: matrix.target == 'x86_64-apple-darwin'
        run: cargo build --release --target ${{ matrix.target }} --features video
        env:
          ORT_STRATEGY: system
          ORT_LIB_LOCATION: ${{ github.workspace }}/onnxruntime/build/MacOS/Release
          ORT_USE_STATIC_LIBS: true

      - name: üé• Build Release Binary - With Video Support (Other Platforms)
        if: matrix.target != 'x86_64-apple-darwin'
        run: cargo build --release --target ${{ matrix.target }} --features video

      # --- UPX (Image-Only Binary) ---
      - name: üî© Compress Binary with UPX (Windows - Image Only)
        if: matrix.target == 'x86_64-pc-windows-msvc'
        uses: crazy-max/ghaction-upx@v3
        with:
          version: latest
          files: |
            ./target/${{ matrix.target }}/release/scout.exe
          args: -9 -q --lzma

      - name: üî© Compress Binary with UPX (Linux - Image Only)
        if: matrix.target == 'x86_64-unknown-linux-gnu'
        uses: crazy-max/ghaction-upx@v3
        with:
          version: latest
          files: |
            ./target/${{ matrix.target }}/release/scout
          args: -9 -q --lzma

      # --- Package Image-Only Variant ---
      - name: üì¶ Package Artifact - Image Only (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          mkdir -p dist-image
          cp target/${{ matrix.target }}/release/scout dist-image/
          cp LICENSE README.md dist-image/
          cd dist-image
          tar czf ../${{ matrix.artifact-base }}.tar.gz *
          cd ..
        shell: bash

      - name: üì¶ Package Artifact - Image Only (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          mkdir dist-image
          copy target\${{ matrix.target }}\release\scout.exe dist-image\
          copy LICENSE dist-image\
          copy README.md dist-image\
          cd dist-image
          7z a -mx=9 ..\${{ matrix.artifact-base }}.zip *
          cd ..
        shell: pwsh

      # --- Package Video Variant ---
      - name: üì¶ Package Artifact - Video (Unix)
        if: matrix.os != 'windows-latest'
        run: |
          mkdir -p dist-video
          cp target/${{ matrix.target }}/release/scout dist-video/
          cp LICENSE README.md dist-video/
          cd dist-video
          tar czf ../${{ matrix.artifact-base }}-video.tar.gz *
          cd ..
        shell: bash

      - name: üì¶ Package Artifact - Video (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          mkdir dist-video
          copy target\${{ matrix.target }}\release\scout.exe dist-video\
          copy LICENSE dist-video\
          copy README.md dist-video\
          cd dist-video
          7z a -mx=9 ..\${{ matrix.artifact-base }}-video.zip *
          cd ..
        shell: pwsh

      # --- Upload Both Variants ---
      - name: üì§ Upload Image-Only Artifact (Unix)
        if: matrix.os != 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-base }}.tar.gz
          path: ${{ matrix.artifact-base }}.tar.gz
          if-no-files-found: error
          retention-days: 7

      - name: üì§ Upload Image-Only Artifact (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-base }}.zip
          path: ${{ matrix.artifact-base }}.zip
          if-no-files-found: error
          retention-days: 7

      - name: üì§ Upload Video Artifact (Unix)
        if: matrix.os != 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-base }}-video.tar.gz
          path: ${{ matrix.artifact-base }}-video.tar.gz
          if-no-files-found: error
          retention-days: 7

      - name: üì§ Upload Video Artifact (Windows)
        if: matrix.os == 'windows-latest'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact-base }}-video.zip
          path: ${{ matrix.artifact-base }}-video.zip
          if-no-files-found: error
          retention-days: 7